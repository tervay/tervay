<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ item.name }}</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
          integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <style>
        #result {
            font-family: "Courier New", Courier, monospace;
        }

        body {
            padding-top: 5%;
        }

        form {
            padding-top: 20px;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <div class="card-body">
            {{ item.name }}
        </div>
    </div>

    <form action="" method="post" novalidate id="form">
        {{ form.hidden_tag() }}
        {% for arg_name, field in form_fields %}
        <div class="form-group row">
            {% if arg_name == "submit" %}
            <div class="col-sm-12">
                {{ field(class_="btn btn-primary") }}
            </div>
            {% else %}
            {{ field.label(class_="col-sm-2 col-form-label") }}
            <div class="col-sm-10">
                {{ field(class_="form-control") }}
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </form>

    <div>
        <pre class="alert alert-primary" id="result"></pre>
    </div>
</div>


<script>
    window.onload = () => {
        document.getElementById('form').addEventListener('submit', (e) => {
            document.getElementById('result').innerText = 'Loading...';
            if (e.preventDefault) e.preventDefault();
            const url = "{{ api_endpoint }}";
            let body = {
            {% for arg_name, field in form_fields %}
                {{ arg_name }}:document.getElementById('{{ arg_name }}').value,
            {% endfor %}
            };
            body['refresh'] = document.getElementById('refresh').checked;

            fetch(url, {
                method: 'post',
                body: JSON.stringify(body)
            }).then((r) => {
                return r.json();
            }).then((d) => {
                if (!d.hasOwnProperty('error')) {
                    document.getElementById('result').innerText = `Result (cache hit: ${d['cached']}):\n${d['result']}`;
                } else {
                    document.getElementById('result').innerText = `Error: ${d["error"]}`;
                }
            }).catch((e) => {
                document.getElementById('result').innerText = `Error: ${e}`;
            });
            return false;
        });
    };
</script>
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
        integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
        integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>
</body>
</html>